<section class="content">
  <div class="page-head">
    <div>
      <h2>Metas</h2>
      <p>Crie metas mensais ou anuais.</p>
    </div>
  </div>

  <!-- KPI cards -->
  <div class="kpis">
    <div class="kpi">
      <div class="kpi__icon">üéØ</div>
      <div class="kpi__txt">
        <div class="kpi__label">Metas criadas</div>
        <div class="kpi__value">{{ totalMetas }}</div>
        <div class="kpi__sub">Inclui mensal e anual</div>
      </div>
      <div class="kpi__chev">‚Ä∫</div>
    </div>

    <div class="kpi">
      <div class="kpi__icon">üóìÔ∏è</div>
      <div class="kpi__txt">
        <div class="kpi__label">Metas anuais</div>
        <div class="kpi__value">{{ metasAnuais }}</div>
      </div>
      <div class="kpi__chev">‚Ä∫</div>
    </div>

    <div class="kpi">
      <div class="kpi__icon">üìÜ</div>
      <div class="kpi__txt">
        <div class="kpi__label">Metas mensais</div>
        <div class="kpi__value">{{ metasMensais }}</div>
      </div>
      <div class="kpi__chev">‚Ä∫</div>
    </div>
  </div>

  <!-- Main grid -->
  <div class="grid">
    <!-- Left: goals list -->
    <div class="panel panel--list">
      <div class="panel__head">
        <h2>Minhas Metas</h2>

        <div class="sort">
          <label class="sort__label">Ordenar</label>
          <select class="sort__select" [(ngModel)]="sortFilter">
            <option value="todas">Todas</option>
            <option value="mensal">Mensais</option>
            <option value="anual">Anuais</option>
          </select>
        </div>
      </div>

      <div class="list" *ngIf="goalsView.length; else empty">
        <div class="row" *ngFor="let g of goalsView; trackBy: trackByGoalId">
          <div class="row__left">
            <div class="avatar">üéØ</div>

            <div class="info">
              <div class="title">
                <span class="name">{{ getGoalTitle(g) }}</span>
                <span class="badge"
                  >{{ g.month === 0 ? 'Anual' : 'Mensal' }}</span
                >
              </div>

              <div class="chips">
                <span class="chip chip--neutral">Ano: {{ g.year }}</span>
                <span class="chip chip--soft">
                  {{ g.month === 0 ? 'M√™s: 0 (anual)' : ('M√™s: ' + g.month) }}
                </span>
              </div>

              <div class="progress">
                <div class="progress__bar" aria-hidden="true">
                  <div
                    class="progress__fill"
                    [style.width.%]="getProgressPct(g)"
                  ></div>
                </div>

                <div class="progress__meta">
                  <span>
                    Alvo:
                    <strong>{{ formatBRL(g.goal) }}</strong>
                    ‚Ä¢ Guardado:
                    <strong
                      [class.pos]="getSaved(g) > 0"
                      [class.neg]="getSaved(g) < 0"
                    >
                      {{ formatBRL(getSaved(g)) }}
                    </strong>
                    ‚Ä¢ Falta:
                    <strong>{{ formatBRL(getRemaining(g)) }}</strong>
                  </span>

                  <span class="muted"
                    >{{ g.updatedAt | date:'dd/MM/yyyy HH:mm' }}</span
                  >
                </div>
              </div>
            </div>
          </div>

          <div class="row__right">
            <div class="amount">
              <div class="amount__main">
                Valor (meta):
                <strong>{{ formatBRL(g.goal) }}</strong>
              </div>

              <div class="amount__sub">
                Impacto no saldo:
                <strong
                  [class.pos]="getSaved(g) > 0"
                  [class.neg]="getSaved(g) < 0"
                >
                  {{ formatBRL(getSaved(g)) }}
                </strong>
              </div>

              <div class="amount__sub">
                Atualizado em {{ g.updatedAt | date:'dd/MM/yyyy' }}
              </div>
            </div>

            <div class="row__btns">
              <button
                class="btn btn-ghost"
                type="button"
                (click)="editarMeta(g)"
              >
                Editar
              </button>
              <button
                class="btn btn-ghost"
                type="button"
                (click)="excluirMeta(g)"
              >
                Excluir
              </button>
            </div>
          </div>
        </div>
      </div>

      <ng-template #empty>
        <div class="empty">
          <h3>Nenhuma meta encontrada</h3>
          <p>Crie uma meta mensal ou anual.</p>
          <button
            class="btn btn-primary"
            type="button"
            (click)="abrirCriarMeta()"
          >
            + Nova meta
          </button>
        </div>
      </ng-template>
    </div>

    <!-- Right: insights -->
    <aside class="panel panel--side">
    <!-- <div class="insight">
        <div class="insight__head">
          <h3>Insight</h3>
          <span class="chev">‚Ä∫</span>
        </div>

        <div class="insight__body">
          <div class="miniicon">üìä</div>
          <div class="text">
            <div class="strong">Organize por per√≠odo</div>
            <div class="muted">
              Para metas anuais, use month = 0. Para mensais, use 1..12 (sem 01,
              02).
            </div>
          </div>
        </div>

        <button class="btn btn-soft" type="button" (click)="abrirCriarMeta()">
          Criar meta
        </button>
      </div> -->

      <div class="insight">
        <div class="insight__head">
          <h3>Guardar na meta</h3>
        </div>

        <div class="insight__body">
          <div class="miniicon">üè¶</div>
          <div class="text meta-save">
            <div class="strong">Lan√ßar valor no saldo</div>
            <div class="muted">
              Guardar = sai do saldo. Tirar = volta para o saldo.
            </div>

            <div class="meta-save__form">
              <div class="meta-save__field">
                <label class="meta-save__label">Meta</label>
                <select
                  class="meta-save__control"
                  [(ngModel)]="guardado.goalKey"
                >
                  <option value="" disabled>Selecione‚Ä¶</option>
                  <option
                    *ngFor="let g of goals; trackBy: trackByGoalId"
                    [ngValue]="(g.year + '-' + g.month)"
                  >
                    {{ getGoalTitle(g) }}
                  </option>
                </select>
              </div>

              <div class="meta-save__row2">
                <div class="meta-save__field">
                  <label class="meta-save__label">A√ß√£o</label>
                  <select
                    class="meta-save__control"
                    [(ngModel)]="guardado.tipo"
                  >
                    <option value="guardar">Guardar (sa√≠da)</option>
                    <option value="tirar">Tirar (entrada)</option>
                  </select>
                </div>

                <div class="meta-save__field">
                  <label class="meta-save__label">Valor</label>
                  <input
                    class="meta-save__control"
                    [(ngModel)]="guardado.valor"
                    placeholder="Ex: 200 ou 200,50"
                  />
                </div>
              </div>

              <div class="meta-save__field">
                <label class="meta-save__label">Descri√ß√£o (opcional)</label>
                <input
                  class="meta-save__control"
                  [(ngModel)]="guardado.desc"
                  placeholder="Ex: Poupan√ßa / Reserva"
                />
              </div>

              <button
                class="btn btn-soft meta-save__btn"
                type="button"
                (click)="lancarGuardado()"
                [disabled]="salvandoGuardado"
              >
                {{ salvandoGuardado ? 'Lan√ßando...' : 'Lan√ßar' }}
              </button>

              <div class="meta-save__msg" *ngIf="guardadoMsg">
                {{ guardadoMsg }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <button
    class="fab"
    type="button"
    (click)="abrirCriarMeta()"
    aria-label="Adicionar meta"
  >
    +
  </button>
</section>

<!-- MODAL -->
<div
  class="modal-backdrop"
  *ngIf="isCreateOpen"
  (click)="fecharCriarMeta()"
></div>

<div class="modal" *ngIf="isCreateOpen" role="dialog" aria-modal="true">
  <div class="modal__header">
    <h3>{{ isEditMode ? 'Editar meta' : 'Criar uma nova meta' }}</h3>
    <button class="iconbtn" type="button" (click)="fecharCriarMeta()">‚úï</button>
  </div>

  <div class="modal__body">
    <div class="rowform">
      <label>T√≠tulo</label>
      <input
        type="text"
        [(ngModel)]="form.title"
        [class.is-invalid]="isInvalidTitle()"
        placeholder="Ex: Reserva, Viagem, Meta do ano..."
      />
    </div>

    <div class="rowform">
      <label>Tipo</label>
      <div class="segmented">
        <button
          type="button"
          class="segmented__btn"
          [class.is-active]="form.tipo === 'mensal'"
          (click)="onTipoChange('mensal')"
        >
          Mensal
        </button>
        <button
          type="button"
          class="segmented__btn"
          [class.is-active]="form.tipo === 'anual'"
          (click)="onTipoChange('anual')"
        >
          Anual
        </button>
      </div>
    </div>

    <div class="rowgrid">
      <div class="rowform">
        <label>Ano</label>
        <input type="number" [(ngModel)]="form.year" />
      </div>

      <div class="rowform" *ngIf="form.tipo === 'mensal'">
        <label>M√™s</label>
        <select [(ngModel)]="form.month">
          <option [ngValue]="1">1</option
          ><option [ngValue]="2">2</option
          ><option [ngValue]="3">3</option>
          <option [ngValue]="4">4</option
          ><option [ngValue]="5">5</option
          ><option [ngValue]="6">6</option>
          <option [ngValue]="7">7</option
          ><option [ngValue]="8">8</option
          ><option [ngValue]="9">9</option>
          <option [ngValue]="10">10</option
          ><option [ngValue]="11">11</option
          ><option [ngValue]="12">12</option>
        </select>
      </div>

      <div class="rowform" *ngIf="form.tipo === 'anual'">
        <label>M√™s</label>
        <input type="number" [ngModel]="0" disabled />
      </div>
    </div>

    <div class="rowform">
      <label>Meta (goal)</label>
      <input
        type="number"
        step="0.01"
        [(ngModel)]="form.goal"
        [class.is-invalid]="isInvalidGoal()"
        placeholder="Ex: 4000 ou -500"
      />
    </div>

    <div class="error" *ngIf="errorMsg">{{ errorMsg }}</div>
  </div>

  <div class="modal__footer">
    <button
      class="btn btn-ghost"
      type="button"
      (click)="fecharCriarMeta()"
      [disabled]="saving"
    >
      Cancelar
    </button>

    <button
      class="btn btn-primary"
      type="button"
      (click)="submitMeta()"
      [disabled]="saving"
    >
      {{ saving ? 'Salvando...' : (isEditMode ? 'Salvar altera√ß√µes' : 'Salvar
      meta') }}
    </button>
  </div>
</div>
